compactor:
  compactor:
    args:
    - -blocks-storage.backend=gcs
    - -blocks-storage.gcs.bucket-name=example-bucket
    - -compactor.block-ranges=2h,12h,24h
    - -compactor.blocks-retention-period=0
    - -compactor.cleanup-interval=15m
    - -compactor.compaction-concurrency=1
    - -compactor.compaction-interval=30m
    - -compactor.compactor-tenant-shard-size=1
    - -compactor.data-dir=/data
    - -compactor.deletion-delay=2h
    - -compactor.max-closing-blocks-concurrency=2
    - -compactor.max-opening-blocks-concurrency=4
    - -compactor.ring.consul.hostname=consul.default.svc.cluster.local:8500
    - -compactor.ring.prefix=
    - -compactor.ring.store=consul
    - -compactor.ring.wait-stability-min-duration=1m
    - -compactor.split-and-merge-shards=0
    - -compactor.split-groups=1
    - -compactor.symbols-flushers-concurrency=4
    - -runtime-config.file=/etc/mimir/overrides.yaml
    - -server.grpc.keepalive.min-time-between-pings=10s
    - -server.grpc.keepalive.ping-without-stream-allowed=true
    - -server.http-listen-port=8080
    - -target=compactor
    image:
      repository: grafana/mimir
      tag: mimir-2.0.0
    resources:
      limits:
        memory: 6Gi
      requests:
        cpu: "1"
        memory: 6Gi
  replicas: 1
consul:
  consul:
    args:
    - agent
    - -ui
    - -server
    - -client=0.0.0.0
    - -config-file=/etc/config/consul-config.json
    - -bootstrap-expect=1
    - -ui-content-path=/default/consul/
    image:
      repository: consul
      tag: 1.5.3
    resources:
      requests:
        cpu: "4"
        memory: 4Gi
  consulConfigJson: '{"leave_on_terminate": true, "raft_snapshot_threshold": 128,
    "raft_trailing_logs": 10000, "telemetry": {"dogstatsd_addr": "127.0.0.1:9125"}}'
  consulExporter:
    args:
    - --consul.server=localhost:8500
    - --web.listen-address=:9107
    - --consul.timeout=1s
    - --no-consul.health-summary
    - --consul.allow_stale
    image:
      repository: prom/consul-exporter
      tag: v0.5.0
  mapping: |
    mappings:
    - match: consul.*.runtime.*
      name: consul_runtime
      labels:
        type: $2
    - match: consul.runtime.total_gc_pause_ns
      name: consul_runtime_total_gc_pause_ns
      labels:
        type: $2
    - match: consul.consul.health.service.query-tag.*.*.*
      name: consul_health_service_query_tag
      labels:
        query: $1.$2.$3
    - match: consul.consul.health.service.query-tag.*.*.*.*
      name: consul_health_service_query_tag
      labels:
        query: $1.$2.$3.$4
    - match: consul.consul.health.service.query-tag.*.*.*.*.*
      name: consul_health_service_query_tag
      labels:
        query: $1.$2.$3.$4.$5
    - match: consul.consul.health.service.query-tag.*.*.*.*.*.*
      name: consul_health_service_query_tag
      labels:
        query: $1.$2.$3.$4.$5.$6
    - match: consul.consul.health.service.query-tag.*.*.*.*.*.*.*
      name: consul_health_service_query_tag
      labels:
        query: $1.$2.$3.$4.$5.$6.$7
    - match: consul.consul.health.service.query-tag.*.*.*.*.*.*.*.*
      name: consul_health_service_query_tag
      labels:
        query: $1.$2.$3.$4.$5.$6.$7.$8
    - match: consul.consul.health.service.query-tag.*.*.*.*.*.*.*.*.*
      name: consul_health_service_query_tag
      labels:
        query: $1.$2.$3.$4.$5.$6.$7.$8.$9
    - match: consul.consul.health.service.query-tag.*.*.*.*.*.*.*.*.*.*
      name: consul_health_service_query_tag
      labels:
        query: $1.$2.$3.$4.$5.$6.$7.$8.$9.$10
    - match: consul.consul.health.service.query-tag.*.*.*.*.*.*.*.*.*.*.*
      name: consul_health_service_query_tag
      labels:
        query: $1.$2.$3.$4.$5.$6.$7.$8.$9.$10.$11
    - match: consul.consul.health.service.query-tag.*.*.*.*.*.*.*.*.*.*.*.*
      name: consul_health_service_query_tag
      labels:
        query: $1.$2.$3.$4.$5.$6.$7.$8.$9.$10.$11.$12
    - match: consul.consul.catalog.deregister
      name: consul_catalog_deregister
      labels: {}
    - match: consul.consul.dns.domain_query.*.*.*.*.*
      name: consul_dns_domain_query
      labels:
        query: $1.$2.$3.$4.$5
    - match: consul.consul.health.service.not-found.*
      name: consul_health_service_not_found
      labels:
        query: $1
    - match: consul.consul.health.service.query.*
      name: consul_health_service_query
      labels:
        query: $1
    - match: consul.*.memberlist.health.score
      name: consul_memberlist_health_score
      labels: {}
    - match: consul.serf.queue.*
      name: consul_serf_events
      labels:
        type: $1
    - match: consul.serf.snapshot.appendLine
      name: consul_serf_snapshot_appendLine
      labels:
        type: $1
    - match: consul.serf.coordinate.adjustment-ms
      name: consul_serf_coordinate_adjustment_ms
      labels: {}
    - match: consul.consul.rpc.query
      name: consul_rpc_query
      labels: {}
    - match: consul.*.consul.session_ttl.active
      name: consul_session_ttl_active
      labels: {}
    - match: consul.raft.rpc.*
      name: consul_raft_rpc
      labels:
        type: $1
    - match: consul.raft.rpc.appendEntries.storeLogs
      name: consul_raft_rpc_appendEntries_storeLogs
      labels:
        type: $1
    - match: consul.consul.fsm.persist
      name: consul_fsm_persist
      labels: {}
    - match: consul.raft.fsm.apply
      name: consul_raft_fsm_apply
      labels: {}
    - match: consul.raft.leader.lastContact
      name: consul_raft_leader_lastcontact
      labels: {}
    - match: consul.raft.leader.dispatchLog
      name: consul_raft_leader_dispatchLog
      labels: {}
    - match: consul.raft.commitTime
      name: consul_raft_commitTime
      labels: {}
    - match: consul.raft.replication.appendEntries.logs.*.*.*.*
      name: consul_raft_replication_appendEntries_logs
      labels:
        query: ${1}.${2}.${3}.${4}
    - match: consul.raft.replication.appendEntries.rpc.*.*.*.*
      name: consul_raft_replication_appendEntries_rpc
      labels:
        query: ${1}.${2}.${3}.${4}
    - match: consul.raft.replication.heartbeat.*.*.*.*
      name: consul_raft_replication_heartbeat
      labels:
        query: ${1}.${2}.${3}.${4}
    - match: consul.consul.rpc.request
      name: consul_rpc_requests
      labels: {}
    - match: consul.consul.rpc.accept_conn
      name: consul_rpc_accept_conn
      labels: {}
    - match: consul.memberlist.udp.*
      name: consul_memberlist_udp
      labels:
        type: $1
    - match: consul.memberlist.tcp.*
      name: consul_memberlist_tcp
      labels:
        type: $1
    - match: consul.memberlist.gossip
      name: consul_memberlist_gossip
      labels: {}
    - match: consul.memberlist.probeNode
      name: consul_memberlist_probenode
      labels: {}
    - match: consul.memberlist.pushPullNode
      name: consul_memberlist_pushpullnode
      labels: {}
    - match: consul.http.*
      name: consul_http_request
      labels:
        method: $1
        path: /
    - match: consul.http.*.*
      name: consul_http_request
      labels:
        method: $1
        path: /$2
    - match: consul.http.*.*.*
      name: consul_http_request
      labels:
        method: $1
        path: /$2/$3
    - match: consul.http.*.*.*.*
      name: consul_http_request
      labels:
        method: $1
        path: /$2/$3/$4
    - match: consul.http.*.*.*.*.*
      name: consul_http_request
      labels:
        method: $1
        path: /$2/$3/$4/$5
    - match: consul.consul.leader.barrier
      name: consul_leader_barrier
      labels: {}
    - match: consul.consul.leader.reconcileMember
      name: consul_leader_reconcileMember
      labels: {}
    - match: consul.consul.leader.reconcile
      name: consul_leader_reconcile
      labels: {}
    - match: consul.consul.fsm.coordinate.batch-update
      name: consul_fsm_coordinate_batch_update
      labels: {}
    - match: consul.consul.fsm.autopilot
      name: consul_fsm_autopilot
      labels: {}
    - match: consul.consul.fsm.kvs.cas
      name: consul_fsm_kvs_cas
      labels: {}
    - match: consul.consul.fsm.register
      name: consul_fsm_register
      labels: {}
    - match: consul.consul.fsm.deregister
      name: consul_fsm_deregister
      labels: {}
    - match: consul.consul.fsm.tombstone.reap
      name: consul_fsm_tombstone_reap
      labels: {}
    - match: consul.consul.catalog.register
      name: consul_catalog_register
      labels: {}
    - match: consul.consul.catalog.deregister
      name: consul_catalog_deregister
      labels: {}
    - match: consul.consul.leader.reapTombstones
      name: consul_leader_reapTombstones
      labels: {}
  ports:
  - name: consul-server
    port: 8300
    targetPort: 8300
  - name: consul-serf
    port: 8301
    targetPort: 8301
  - name: consul-client
    port: 8400
    targetPort: 8400
  - name: consul-api
    port: 8500
    targetPort: 8500
  - name: statsd-exporter-http-metrics
    port: 8000
    targetPort: 8000
  - name: consul-exporter-http-metrics
    port: 9107
    targetPort: 9107
  replicas: 1
  sidekick:
    args:
    - --namespace=$(POD_NAMESPACE)
    - --pod-name=$(POD_NAME)
    image:
      repository: weaveworks/consul-sidekick
      tag: master-f18ad13
  statsdExporter:
    args:
    - --web.listen-address=:8000
    - --statsd.mapping-config=/etc/config/mapping
    image:
      repository: prom/statsd-exporter
      tag: v0.12.2
  type: ClusterIP
distributor:
  distributor:
    args:
    - -distributor.extend-writes=true
    - -distributor.ha-tracker.enable=true
    - -distributor.ha-tracker.enable-for-all-users=true
    - -distributor.ha-tracker.etcd.endpoints=etcd-client.default.svc.cluster.local.:2379
    - -distributor.ha-tracker.prefix=prom_ha/
    - -distributor.ha-tracker.store=etcd
    - -distributor.health-check-ingesters=true
    - -distributor.ingestion-burst-size=200000
    - -distributor.ingestion-rate-limit=10000
    - -distributor.ring.consul.hostname=consul.default.svc.cluster.local:8500
    - -distributor.ring.prefix=
    - -distributor.ring.store=consul
    - -ingester.ring.consul.hostname=consul.default.svc.cluster.local:8500
    - -ingester.ring.heartbeat-timeout=10m
    - -ingester.ring.prefix=
    - -ingester.ring.replication-factor=3
    - -ingester.ring.store=consul
    - -mem-ballast-size-bytes=1073741824
    - -runtime-config.file=/etc/mimir/overrides.yaml
    - -server.grpc.keepalive.max-connection-age=2m
    - -server.grpc.keepalive.max-connection-age-grace=5m
    - -server.grpc.keepalive.max-connection-idle=1m
    - -server.grpc.keepalive.min-time-between-pings=10s
    - -server.grpc.keepalive.ping-without-stream-allowed=true
    - -server.http-listen-port=8080
    - -target=distributor
    image:
      repository: grafana/mimir
      tag: mimir-2.0.0
    resources:
      limits:
        memory: 4Gi
      requests:
        cpu: "2"
        memory: 2Gi
  ports:
  - name: distributor-http-metrics
    port: 8080
    targetPort: 8080
  - name: distributor-grpc
    port: 9095
    targetPort: 9095
  replicas: 3
  type: ClusterIP
ingester:
  ingester:
    args:
    - -blocks-storage.backend=gcs
    - -blocks-storage.gcs.bucket-name=example-bucket
    - -blocks-storage.tsdb.block-ranges-period=2h
    - -blocks-storage.tsdb.close-idle-tsdb-timeout=13h
    - -blocks-storage.tsdb.dir=/data/tsdb
    - -blocks-storage.tsdb.isolation-enabled=false
    - -blocks-storage.tsdb.ship-interval=1m
    - -distributor.health-check-ingesters=true
    - -ingester.max-global-series-per-metric=20000
    - -ingester.max-global-series-per-user=150000
    - -ingester.ring.consul.hostname=consul.default.svc.cluster.local:8500
    - -ingester.ring.heartbeat-period=15s
    - -ingester.ring.heartbeat-timeout=10m
    - -ingester.ring.num-tokens=512
    - -ingester.ring.prefix=
    - -ingester.ring.replication-factor=3
    - -ingester.ring.store=consul
    - -ingester.ring.tokens-file-path=/data/tokens
    - -ingester.ring.unregister-on-shutdown=true
    - -runtime-config.file=/etc/mimir/overrides.yaml
    - -server.grpc-max-concurrent-streams=10000
    - -server.grpc-max-recv-msg-size-bytes=10485760
    - -server.grpc-max-send-msg-size-bytes=10485760
    - -server.grpc.keepalive.min-time-between-pings=10s
    - -server.grpc.keepalive.ping-without-stream-allowed=true
    - -server.http-listen-port=8080
    - -target=ingester
    image:
      repository: grafana/mimir
      tag: mimir-2.0.0
    resources:
      limits:
        memory: 25Gi
      requests:
        cpu: "4"
        memory: 15Gi
  ports:
  - name: ingester-http-metrics
    port: 8080
    targetPort: 8080
  - name: ingester-grpc
    port: 9095
    targetPort: 9095
  replicas: 3
  type: ClusterIP
memcached:
  exporter:
    args:
    - --memcached.address=localhost:11211
    - --web.listen-address=0.0.0.0:9150
    image:
      repository: prom/memcached-exporter
      tag: v0.6.0
  memcached:
    args:
    - -m 6144
    - -I 1m
    - -c 16384
    - -v
    image:
      repository: memcached
      tag: 1.6.9-alpine
    resources:
      limits:
        memory: 9Gi
      requests:
        cpu: 500m
        memory: 6552Mi
  ports:
  - name: memcached-client
    port: 11211
    targetPort: 11211
  - name: exporter-http-metrics
    port: 9150
    targetPort: 9150
  replicas: 3
  type: ClusterIP
memcachedFrontend:
  exporter:
    args:
    - --memcached.address=localhost:11211
    - --web.listen-address=0.0.0.0:9150
    image:
      repository: prom/memcached-exporter
      tag: v0.6.0
  memcached:
    args:
    - -m 1024
    - -I 5m
    - -c 1024
    - -v
    image:
      repository: memcached
      tag: 1.6.9-alpine
    resources:
      limits:
        memory: 1536Mi
      requests:
        cpu: 500m
        memory: 1329Mi
  ports:
  - name: memcached-client
    port: 11211
    targetPort: 11211
  - name: exporter-http-metrics
    port: 9150
    targetPort: 9150
  replicas: 3
  type: ClusterIP
memcachedIndexQueries:
  exporter:
    args:
    - --memcached.address=localhost:11211
    - --web.listen-address=0.0.0.0:9150
    image:
      repository: prom/memcached-exporter
      tag: v0.6.0
  memcached:
    args:
    - -m 1024
    - -I 5m
    - -c 16384
    - -v
    image:
      repository: memcached
      tag: 1.6.9-alpine
    resources:
      limits:
        memory: 1536Mi
      requests:
        cpu: 500m
        memory: 1329Mi
  ports:
  - name: memcached-client
    port: 11211
    targetPort: 11211
  - name: exporter-http-metrics
    port: 9150
    targetPort: 9150
  replicas: 3
  type: ClusterIP
memcachedMetadata:
  exporter:
    args:
    - --memcached.address=localhost:11211
    - --web.listen-address=0.0.0.0:9150
    image:
      repository: prom/memcached-exporter
      tag: v0.6.0
  memcached:
    args:
    - -m 512
    - -I 1m
    - -c 16384
    - -v
    image:
      repository: memcached
      tag: 1.6.9-alpine
    resources:
      limits:
        memory: 768Mi
      requests:
        cpu: 500m
        memory: 715Mi
  ports:
  - name: memcached-client
    port: 11211
    targetPort: 11211
  - name: exporter-http-metrics
    port: 9150
    targetPort: 9150
  replicas: 1
  type: ClusterIP
overrides:
  overridesYaml:
    overrides: {}
querier:
  ports:
  - name: querier-http-metrics
    port: 8080
    targetPort: 8080
  - name: querier-grpc
    port: 9095
    targetPort: 9095
  querier:
    args:
    - -blocks-storage.backend=gcs
    - -blocks-storage.bucket-store.metadata-cache.backend=memcached
    - -blocks-storage.bucket-store.metadata-cache.memcached.addresses=dnssrvnoa+memcached-metadata.default.svc.cluster.local:11211
    - -blocks-storage.bucket-store.metadata-cache.memcached.max-async-concurrency=50
    - -blocks-storage.bucket-store.metadata-cache.memcached.max-item-size=1048576
    - -blocks-storage.bucket-store.sync-dir=/data/tsdb
    - -blocks-storage.bucket-store.sync-interval=15m
    - -blocks-storage.gcs.bucket-name=example-bucket
    - -distributor.health-check-ingesters=true
    - -ingester.ring.consul.hostname=consul.default.svc.cluster.local:8500
    - -ingester.ring.heartbeat-timeout=10m
    - -ingester.ring.prefix=
    - -ingester.ring.replication-factor=3
    - -ingester.ring.store=consul
    - -mem-ballast-size-bytes=268435456
    - -querier.frontend-address=query-frontend-discovery.default.svc.cluster.local:9095
    - -querier.frontend-client.grpc-max-send-msg-size=104857600
    - -querier.max-concurrent=8
    - -querier.query-ingesters-within=13h
    - -querier.query-store-after=12h
    - -runtime-config.file=/etc/mimir/overrides.yaml
    - -server.grpc.keepalive.min-time-between-pings=10s
    - -server.grpc.keepalive.ping-without-stream-allowed=true
    - -server.http-listen-port=8080
    - -server.http-write-timeout=1m
    - -store-gateway.sharding-ring.consul.hostname=consul.default.svc.cluster.local:8500
    - -store-gateway.sharding-ring.prefix=
    - -store-gateway.sharding-ring.replication-factor=3
    - -store-gateway.sharding-ring.store=consul
    - -store.max-query-length=768h
    - -target=querier
    image:
      repository: grafana/mimir
      tag: mimir-2.0.0
    resources:
      limits:
        memory: 24Gi
      requests:
        cpu: "1"
        memory: 12Gi
  replicas: 6
  type: ClusterIP
queryFrontend:
  ports:
  - name: query-frontend-http-metrics
    port: 8080
    targetPort: 8080
  - name: query-frontend-grpc
    port: 9095
    targetPort: 9095
  queryFrontend:
    args:
    - -query-frontend.align-querier-with-step=false
    - -query-frontend.cache-results=true
    - -query-frontend.max-cache-freshness=10m
    - -query-frontend.results-cache.backend=memcached
    - -query-frontend.results-cache.memcached.addresses=dnssrvnoa+memcached-frontend.default.svc.cluster.local:11211
    - -query-frontend.results-cache.memcached.timeout=500ms
    - -runtime-config.file=/etc/mimir/overrides.yaml
    - -server.grpc-max-recv-msg-size-bytes=104857600
    - -server.grpc.keepalive.min-time-between-pings=10s
    - -server.grpc.keepalive.ping-without-stream-allowed=true
    - -server.http-listen-port=8080
    - -server.http-write-timeout=1m
    - -store.max-query-length=12000h
    - -target=query-frontend
    image:
      repository: grafana/mimir
      tag: mimir-2.0.0
    resources:
      limits:
        memory: 1200Mi
      requests:
        cpu: "2"
        memory: 600Mi
  replicas: 2
  type: ClusterIP
queryFrontendDiscovery:
  ports:
  - name: query-frontend-http-metrics
    port: 8080
    targetPort: 8080
  - name: query-frontend-grpc
    port: 9095
    targetPort: 9095
  type: ClusterIP
storeGateway:
  ports:
  - name: store-gateway-http-metrics
    port: 8080
    targetPort: 8080
  - name: store-gateway-grpc
    port: 9095
    targetPort: 9095
  replicas: 3
  storeGateway:
    args:
    - -blocks-storage.backend=gcs
    - -blocks-storage.bucket-store.chunks-cache.attributes-in-memory-max-items=50000
    - -blocks-storage.bucket-store.chunks-cache.backend=memcached
    - -blocks-storage.bucket-store.chunks-cache.memcached.addresses=dnssrvnoa+memcached.default.svc.cluster.local:11211
    - -blocks-storage.bucket-store.chunks-cache.memcached.max-async-concurrency=50
    - -blocks-storage.bucket-store.chunks-cache.memcached.max-get-multi-concurrency=100
    - -blocks-storage.bucket-store.chunks-cache.memcached.max-idle-connections=100
    - -blocks-storage.bucket-store.chunks-cache.memcached.max-item-size=1048576
    - -blocks-storage.bucket-store.ignore-blocks-within=10h
    - -blocks-storage.bucket-store.index-cache.backend=memcached
    - -blocks-storage.bucket-store.index-cache.memcached.addresses=dnssrvnoa+memcached-index-queries.default.svc.cluster.local:11211
    - -blocks-storage.bucket-store.index-cache.memcached.max-async-concurrency=50
    - -blocks-storage.bucket-store.index-cache.memcached.max-get-multi-concurrency=100
    - -blocks-storage.bucket-store.index-cache.memcached.max-idle-connections=100
    - -blocks-storage.bucket-store.index-cache.memcached.max-item-size=5242880
    - -blocks-storage.bucket-store.index-header-lazy-loading-enabled=true
    - -blocks-storage.bucket-store.index-header-lazy-loading-idle-timeout=60m
    - -blocks-storage.bucket-store.max-chunk-pool-bytes=12884901888
    - -blocks-storage.bucket-store.metadata-cache.backend=memcached
    - -blocks-storage.bucket-store.metadata-cache.memcached.addresses=dnssrvnoa+memcached-metadata.default.svc.cluster.local:11211
    - -blocks-storage.bucket-store.metadata-cache.memcached.max-async-concurrency=50
    - -blocks-storage.bucket-store.metadata-cache.memcached.max-get-multi-concurrency=100
    - -blocks-storage.bucket-store.metadata-cache.memcached.max-idle-connections=100
    - -blocks-storage.bucket-store.metadata-cache.memcached.max-item-size=1048576
    - -blocks-storage.bucket-store.sync-dir=/data/tsdb
    - -blocks-storage.bucket-store.sync-interval=15m
    - -blocks-storage.gcs.bucket-name=example-bucket
    - -runtime-config.file=/etc/mimir/overrides.yaml
    - -server.grpc.keepalive.min-time-between-pings=10s
    - -server.grpc.keepalive.ping-without-stream-allowed=true
    - -server.http-listen-port=8080
    - -store-gateway.sharding-ring.consul.hostname=consul.default.svc.cluster.local:8500
    - -store-gateway.sharding-ring.prefix=
    - -store-gateway.sharding-ring.replication-factor=3
    - -store-gateway.sharding-ring.store=consul
    - -store-gateway.sharding-ring.tokens-file-path=/data/tokens
    - -store-gateway.sharding-ring.wait-stability-min-duration=1m
    - -target=store-gateway
    image:
      repository: grafana/mimir
      tag: mimir-2.0.0
    resources:
      limits:
        memory: 18Gi
      requests:
        cpu: "1"
        memory: 12Gi
  type: ClusterIP
